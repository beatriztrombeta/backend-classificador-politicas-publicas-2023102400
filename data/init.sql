-- =========================
-- ENUMS
-- =========================

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'status_cadastro_enum') THEN
    CREATE TYPE status_cadastro_enum AS ENUM (
      'PENDENTE',
      'APROVADO',
      'REJEITADO'
    );
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'status_analise_enum') THEN
    CREATE TYPE status_analise_enum AS ENUM (
      'PENDENTE',
      'APROVADO',
      'REJEITADO'
    );
  END IF;
END $$;

-- =========================
-- TABELAS ACADÊMICAS (BASE)
-- =========================

CREATE TABLE IF NOT EXISTS CAMPUS (
  ID_CAMPUS SERIAL PRIMARY KEY,
  NOME_CAMPUS VARCHAR NOT NULL
);

CREATE TABLE IF NOT EXISTS UNIDADE (
  ID_UNIDADE SERIAL PRIMARY KEY,
  ID_CAMPUS INTEGER NOT NULL,
  NOME_UNIDADE VARCHAR NOT NULL,
  CONSTRAINT FK_UNIDADE_CAMPUS FOREIGN KEY (ID_CAMPUS) REFERENCES CAMPUS (ID_CAMPUS)
);

CREATE TABLE IF NOT EXISTS DEPARTAMENTO (
  ID_DEPARTAMENTO SERIAL PRIMARY KEY,
  ID_UNIDADE INTEGER NOT NULL,
  NOME_DEPARTAMENTO VARCHAR NOT NULL,
  CONSTRAINT FK_DEP_UNIDADE FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE)
);

CREATE TABLE IF NOT EXISTS PERIODO (
  ID_PERIODO SERIAL PRIMARY KEY,
  PERIODO VARCHAR NOT NULL
);

CREATE TABLE IF NOT EXISTS CURSO (
  ID_CURSO SERIAL PRIMARY KEY,
  ID_UNIDADE INTEGER NOT NULL,
  ID_PERIODO INTEGER NOT NULL,
  NOME_CURSO VARCHAR NOT NULL,
  MODALIDADE VARCHAR,
  CONSTRAINT FK_CURSO_UNIDADE FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE),
  CONSTRAINT FK_CURSO_PERIODO FOREIGN KEY (ID_PERIODO) REFERENCES PERIODO (ID_PERIODO)
);

CREATE TABLE IF NOT EXISTS DISCIPLINA (
  ID_DISCIPLINA SERIAL PRIMARY KEY,
  ID_CURSO INTEGER NOT NULL,
  NOME_DISCIPLINA VARCHAR NOT NULL,
  CONSTRAINT FK_DISCIPLINA_CURSO FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

-- =========================
-- USUÁRIO
-- =========================

CREATE TABLE IF NOT EXISTS CATEGORIA_USUARIO (
  ID_CATEGORIA_USUARIO SERIAL PRIMARY KEY,
  NOME_CATEGORIA VARCHAR NOT NULL
);

CREATE TABLE IF NOT EXISTS USUARIO (
  ID_USUARIO SERIAL PRIMARY KEY,
  ID_CATEGORIA_USUARIO INTEGER NOT NULL,
  NOME VARCHAR NOT NULL,
  EMAIL VARCHAR UNIQUE NOT NULL,
  CPF VARCHAR,
  TELEFONE VARCHAR,
  STATUS_CADASTRO status_cadastro_enum NOT NULL,
  DATA_CADASTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  DATA_ATUALIZACAO TIMESTAMP,
  CONSTRAINT FK_USUARIO_CATEGORIA FOREIGN KEY (ID_CATEGORIA_USUARIO) REFERENCES CATEGORIA_USUARIO (ID_CATEGORIA_USUARIO)
);

CREATE TABLE IF NOT EXISTS DOCUMENTO_USUARIO (
  ID_DOCUMENTO SERIAL PRIMARY KEY,
  ID_USUARIO INTEGER NOT NULL,
  TIPO_DOCUMENTO VARCHAR NOT NULL,
  STORAGE_PROVIDER VARCHAR NOT NULL,
  STORAGE_BUCKET VARCHAR,
  STORAGE_KEY VARCHAR NOT NULL,
  HASH_ARQUIVO VARCHAR NOT NULL,
  MIME_TYPE VARCHAR,
  TAMANHO_ARQUIVO INTEGER,
  DATA_ENVIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  STATUS_ANALISE status_analise_enum NOT NULL,
  CONSTRAINT FK_DOC_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO)
);

-- =========================
-- PRÓ-REITORIA / REITORIA
-- =========================

CREATE TABLE IF NOT EXISTS TIPO_PROREITORIA (
  ID_TIPO_PROREITORIA SERIAL PRIMARY KEY,
  NOME_PROREITORIA VARCHAR NOT NULL
);

CREATE TABLE IF NOT EXISTS USUARIO_REITOR (
  ID_USUARIO INTEGER NOT NULL,
  ID_CAMPUS INTEGER NOT NULL,
  PRIMARY KEY (ID_USUARIO, ID_CAMPUS),
  CONSTRAINT FK_REITOR_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  CONSTRAINT FK_REITOR_CAMPUS FOREIGN KEY (ID_CAMPUS) REFERENCES CAMPUS (ID_CAMPUS)
);

CREATE TABLE IF NOT EXISTS USUARIO_PROREI (
  ID_USUARIO INTEGER NOT NULL,
  ID_CAMPUS INTEGER NOT NULL,
  ID_PROREITORIA INTEGER NOT NULL,
  PRIMARY KEY (ID_USUARIO, ID_PROREITORIA),
  CONSTRAINT FK_PROREI_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  CONSTRAINT FK_PROREI_CAMPUS FOREIGN KEY (ID_CAMPUS) REFERENCES CAMPUS (ID_CAMPUS),
  CONSTRAINT FK_PROREI_TIPO FOREIGN KEY (ID_PROREITORIA) REFERENCES TIPO_PROREITORIA (ID_TIPO_PROREITORIA)
);

-- =========================
-- VÍNCULOS USUÁRIO
-- =========================

CREATE TABLE IF NOT EXISTS USUARIO_DEPARTAMENTO (
  ID_USUARIO INTEGER NOT NULL,
  ID_UNIDADE INTEGER NOT NULL,
  ID_DEPARTAMENTO INTEGER NOT NULL,
  PRIMARY KEY (ID_USUARIO, ID_DEPARTAMENTO),
  CONSTRAINT FK_USU_DEP_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  CONSTRAINT FK_USU_DEP_UNIDADE FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE),
  CONSTRAINT FK_USU_DEP_DEP FOREIGN KEY (ID_DEPARTAMENTO) REFERENCES DEPARTAMENTO (ID_DEPARTAMENTO)
);

CREATE TABLE IF NOT EXISTS USUARIO_COORDENADOR (
  ID_USUARIO INTEGER NOT NULL,
  ID_UNIDADE INTEGER NOT NULL,
  ID_CURSO INTEGER NOT NULL,
  PRIMARY KEY (ID_USUARIO, ID_CURSO),
  CONSTRAINT FK_USU_COORD_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  CONSTRAINT FK_USU_COORD_UNIDADE FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE),
  CONSTRAINT FK_USU_COORD_CURSO FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

CREATE TABLE IF NOT EXISTS USUARIO_PROFESSOR (
  ID_USUARIO INTEGER NOT NULL,
  ID_UNIDADE INTEGER NOT NULL,
  ID_DISCIPLINA INTEGER NOT NULL,
  PRIMARY KEY (ID_USUARIO, ID_DISCIPLINA),
  CONSTRAINT FK_USU_PROF_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  CONSTRAINT FK_USU_PROF_UNIDADE FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE),
  CONSTRAINT FK_USU_PROF_DISC FOREIGN KEY (ID_DISCIPLINA) REFERENCES DISCIPLINA (ID_DISCIPLINA)
);

-- =========================
-- ALUNO
-- =========================

CREATE TABLE IF NOT EXISTS ALUNO (
  ID_ALUNO_GRADUACAO SERIAL PRIMARY KEY,
  ID_CURSO INTEGER NOT NULL,
  RACA_COR VARCHAR,
  SEXO VARCHAR,
  ANO_NASCIMENTO INTEGER,
  ENSINO_MEDIO VARCHAR,
  CIDADE_ORIGEM VARCHAR,
  ESTADO_ORIGEM VARCHAR,
  PAIS_ORIGEM VARCHAR,
  COTAS VARCHAR,
  TIPO_INGRESSO VARCHAR,
  FORMA_INGRESSO VARCHAR,
  ANO_MATRICULA INTEGER,
  SITUACAO VARCHAR,
  MOTIVO_DESVINCULO VARCHAR,
  DATA_DESVINCULO TIMESTAMP,
  CR DECIMAL,
  MAX_NOTA DECIMAL,
  MIN_NOTA DECIMAL,
  AVG_NOTA DECIMAL,
  MEDIAN_NOTA DECIMAL,
  UNIQUE_DISCIPLINAS INTEGER,
  MAX_FREQUENCIA DECIMAL,
  MIN_FREQUENCIA DECIMAL,
  AVG_FREQUENCIA DECIMAL,
  MEDIAN_FREQUENCIA DECIMAL,
  IDADE_MATRICULA INTEGER,
  PERC_REPROVACAO DECIMAL,
  PERC_EXAMES DECIMAL,
  DISTANCIA_CAMPUS DECIMAL,

  CONSTRAINT FK_ALUNO_CURSO FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

CREATE TABLE IF NOT EXISTS USUARIO_ALUNO (
  ID_USUARIO INTEGER NOT NULL,
  ID_UNIDADE INTEGER NOT NULL,
  ID_ALUNO_GRADUACAO INTEGER NOT NULL,
  PRIMARY KEY (ID_USUARIO, ID_ALUNO_GRADUACAO),
  CONSTRAINT FK_USU_ALUNO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  CONSTRAINT FK_USU_ALUNO_UNIDADE FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE),
  CONSTRAINT FK_USU_ALUNO_ALUNO FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO)
);

CREATE TABLE IF NOT EXISTS ALUNO_DISCIPLINA (
  ID_ALUNO_GRADUACAO INTEGER NOT NULL,
  ID_DISCIPLINA INTEGER NOT NULL,
  CONCEITO VARCHAR,
  FREQUENCIA DECIMAL,
  TIPO_EFETIVACAO VARCHAR,
  TIPO_NOTA VARCHAR,
  NOTA DECIMAL,
  PRIMARY KEY (ID_ALUNO_GRADUACAO, ID_DISCIPLINA),
  CONSTRAINT FK_ALU_DISC_ALUNO FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO),
  CONSTRAINT FK_ALU_DISC_DISC FOREIGN KEY (ID_DISCIPLINA) REFERENCES DISCIPLINA (ID_DISCIPLINA)
);

-- =========================
-- MODELO
-- =========================

CREATE TABLE IF NOT EXISTS PESO_FEATURES (
  ID_FEATURE SERIAL PRIMARY KEY,
  ID_ALUNO_GRADUACAO INTEGER,
  FEATURE VARCHAR NOT NULL,
  PESO DECIMAL,
  DESCRICAO VARCHAR,
  CONSTRAINT FK_PESO_ALUNO FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO)
);

CREATE TABLE IF NOT EXISTS OUTPUT_MODELO (
  ID_ALUNO_GRADUACAO INTEGER PRIMARY KEY,
  CLASSIFICACAO DECIMAL,
  CONSTRAINT FK_OUT_ALUNO FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO)
);