-- =========================
-- ENUMS
-- =========================

CREATE TYPE status_cadastro_enum AS ENUM (
  'PENDENTE',
  'APROVADO',
  'REJEITADO'
);

CREATE TYPE status_analise_enum AS ENUM (
  'PENDENTE',
  'APROVADO',
  'REJEITADO'
);

-- =========================
-- TABELAS BÁSICAS
-- =========================

CREATE TABLE PERFIL_USUARIO (
  ID_PERFIL SERIAL PRIMARY KEY,
  NOME_PERFIL VARCHAR NOT NULL,
  DESCRICAO VARCHAR
);

CREATE TABLE CAMPUS (
  ID_CAMPUS SERIAL PRIMARY KEY,
  NOME_CAMPUS VARCHAR NOT NULL
);

CREATE TABLE UNIDADE (
  ID_UNIDADE SERIAL PRIMARY KEY,
  ID_CAMPUS INTEGER NOT NULL,
  NOME_UNIDADE VARCHAR NOT NULL,
  FOREIGN KEY (ID_CAMPUS) REFERENCES CAMPUS (ID_CAMPUS)
);

CREATE TABLE DEPARTAMENTO (
  ID_DEPARTAMENTO SERIAL PRIMARY KEY,
  ID_UNIDADE INTEGER NOT NULL,
  NOME_DEPARTAMENTO VARCHAR NOT NULL,
  FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE)
);

CREATE TABLE PERIODO (
  ID_PERIODO SERIAL PRIMARY KEY,
  PERIODO VARCHAR NOT NULL
);

CREATE TABLE CURSO (
  ID_CURSO SERIAL PRIMARY KEY,
  ID_UNIDADE INTEGER NOT NULL,
  ID_PERIODO INTEGER NOT NULL,
  NOME_CURSO VARCHAR NOT NULL,
  MODALIDADE VARCHAR,
  FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE),
  FOREIGN KEY (ID_PERIODO) REFERENCES PERIODO (ID_PERIODO)
);

CREATE TABLE DISCIPLINA (
  ID_DISCIPLINA SERIAL PRIMARY KEY,
  ID_CURSO INTEGER NOT NULL,
  NOME_DISCIPLINA VARCHAR NOT NULL,
  FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

CREATE TABLE DEPARTAMENTO_CURSO (
  ID_DEPARTAMENTO INTEGER,
  ID_CURSO INTEGER,
  PRIMARY KEY (ID_DEPARTAMENTO, ID_CURSO),
  FOREIGN KEY (ID_DEPARTAMENTO) REFERENCES DEPARTAMENTO (ID_DEPARTAMENTO),
  FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

-- =========================
-- USUÁRIO
-- =========================

CREATE TABLE USUARIO (
  ID_USUARIO SERIAL PRIMARY KEY,
  ID_PERFIL INTEGER NOT NULL,
  ID_CAMPUS INTEGER,
  ID_UNIDADE INTEGER,
  NOME VARCHAR NOT NULL,
  EMAIL VARCHAR UNIQUE NOT NULL,
  CPF VARCHAR,
  TELEFONE VARCHAR,
  STATUS_CADASTRO status_cadastro_enum NOT NULL,
  DATA_CADASTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  DATA_ATUALIZACAO TIMESTAMP,
  FOREIGN KEY (ID_PERFIL) REFERENCES PERFIL_USUARIO (ID_PERFIL),
  FOREIGN KEY (ID_CAMPUS) REFERENCES CAMPUS (ID_CAMPUS),
  FOREIGN KEY (ID_UNIDADE) REFERENCES UNIDADE (ID_UNIDADE)
);

CREATE TABLE DOCUMENTO_USUARIO (
  ID_DOCUMENTO SERIAL PRIMARY KEY,
  ID_USUARIO INTEGER NOT NULL,
  TIPO_DOCUMENTO VARCHAR NOT NULL,
  STORAGE_PROVIDER VARCHAR NOT NULL,
  STORAGE_BUCKET VARCHAR,
  STORAGE_KEY VARCHAR NOT NULL,
  HASH_ARQUIVO VARCHAR NOT NULL,
  MIME_TYPE VARCHAR,
  TAMANHO_ARQUIVO INTEGER,
  DATA_ENVIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  STATUS_ANALISE status_analise_enum NOT NULL,
  FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO)
);

-- =========================
-- VÍNCULOS USUÁRIO
-- =========================

CREATE TABLE USUARIO_DEPARTAMENTO (
  ID_USUARIO INTEGER,
  ID_DEPARTAMENTO INTEGER,
  PRIMARY KEY (ID_USUARIO, ID_DEPARTAMENTO),
  FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  FOREIGN KEY (ID_DEPARTAMENTO) REFERENCES DEPARTAMENTO (ID_DEPARTAMENTO)
);

CREATE TABLE USUARIO_COORDENADOR (
  ID_USUARIO INTEGER,
  ID_CURSO INTEGER,
  PRIMARY KEY (ID_USUARIO, ID_CURSO),
  FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

CREATE TABLE USUARIO_PROFESSOR (
  ID_USUARIO INTEGER,
  ID_CURSO INTEGER,
  PRIMARY KEY (ID_USUARIO, ID_CURSO),
  FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

-- =========================
-- ALUNO
-- =========================

CREATE TABLE ALUNO (
  ID_ALUNO_GRADUACAO SERIAL PRIMARY KEY,
  ID_CURSO INTEGER NOT NULL,
  RACA_COR VARCHAR,
  SEXO VARCHAR,
  ANO_NASCIMENTO INTEGER,
  ENSINO_MEDIO VARCHAR,
  CIDADE_ORIGEM VARCHAR,
  ESTADO_ORIGEM VARCHAR,
  PAIS_ORIGEM VARCHAR,
  COTAS VARCHAR,
  TIPO_INGRESSO VARCHAR,
  FORMA_INGRESSO VARCHAR,
  ANO_MATRICULA INTEGER,
  SITUACAO VARCHAR,
  MOTIVO_DESVINCULO VARCHAR,
  DATA_DESVINCULO TIMESTAMP,
  CR DECIMAL,
  MAX_NOTA DECIMAL,
  MIN_NOTA DECIMAL,
  AVG_NOTA DECIMAL,
  MEDIAN_NOTA DECIMAL,
  UNIQUE_DISCIPLINAS INTEGER,
  MAX_FREQUENCIA DECIMAL,
  MIN_FREQUENCIA DECIMAL,
  AVG_FREQUENCIA DECIMAL,
  MEDIAN_FREQUENCIA DECIMAL,
  IDADE_MATRICULA INTEGER,
  PERC_REPROVACAO DECIMAL,
  PERC_EXAMES DECIMAL,
  DISTANCIA_CAMPUS DECIMAL,
  FOREIGN KEY (ID_CURSO) REFERENCES CURSO (ID_CURSO)
);

CREATE TABLE USUARIO_ALUNO (
  ID_USUARIO INTEGER,
  ID_ALUNO_GRADUACAO INTEGER,
  PRIMARY KEY (ID_USUARIO, ID_ALUNO_GRADUACAO),
  FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO (ID_USUARIO),
  FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO)
);

CREATE TABLE ALUNO_DISCIPLINA (
  ID_ALUNO_GRADUACAO INTEGER,
  ID_DISCIPLINA INTEGER,
  CONCEITO VARCHAR,
  FREQUENCIA DECIMAL,
  TIPO_EFETIVACAO VARCHAR,
  TIPO_NOTA VARCHAR,
  NOTA DECIMAL,
  PRIMARY KEY (ID_ALUNO_GRADUACAO, ID_DISCIPLINA),
  FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO),
  FOREIGN KEY (ID_DISCIPLINA) REFERENCES DISCIPLINA (ID_DISCIPLINA)
);

-- =========================
-- MODELO
-- =========================

CREATE TABLE PESO_FEATURES (
  ID_FEATURE SERIAL PRIMARY KEY,
  ID_ALUNO_GRADUACAO INTEGER,
  FEATURE VARCHAR NOT NULL,
  PESO DECIMAL,
  DESCRICAO VARCHAR,
  FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO)
);

CREATE TABLE OUTPUT_MODELO (
  ID_ALUNO_GRADUACAO INTEGER PRIMARY KEY,
  CLASSIFICACAO DECIMAL,
  FOREIGN KEY (ID_ALUNO_GRADUACAO) REFERENCES ALUNO (ID_ALUNO_GRADUACAO)
);
